---
AWSTemplateFormatVersion: '2010-09-09'
Description: GrassFormation test to create a complete Greengrass Stack
Parameters:
  GroupNameParameter:
    Type: String
    Description: "Name of the Greengrass Group"
  CoreShadowHandlerARN:
    Type: String
    Description: "The ARN of the lambda function that should handle the Core Shadow"
  CSRParameter:
    Type: String
    Description: "The Certificate Signing Request for the Core certificate"
  GFStackName:
    Type: String
    Description: "The name of the CloudFormation stack that deployed the GrassFormation lambda handlers"
    Default: grassformation-dev
  IoTLambdaARN:
    Type: String
    Description: "The fully qualified ARN of the lambda function that should be deployed on the core"

Resources:

  CoreCert:
    Type: AWS::IoT::Certificate
    Properties:
      CertificateSigningRequest: !Ref CSRParameter
      Status: ACTIVE

  CoreThing:
    Type: AWS::IoT::Thing
    Properties:
      ThingName: !Join ["_", [!Ref GroupNameParameter, "Core"]]

  CoreCertCoreThingAttachment:
    Type: AWS::IoT::ThingPrincipalAttachment
    Properties:
      Principal: !GetAtt CoreCert.Arn
      ThingName: !Ref CoreThing

  CorePolicy:
    Type: AWS::IoT::Policy
    Properties:
      PolicyName: !Join ["_", [!Ref GroupNameParameter, "Policy"]]
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action: ["iot:Publish", "iot:Subscribe", "iot:Connect", "iot:Receive"]
          Resource: "*"
        - Effect: Allow
          Action: ["iot:GetThingShadow", "iot:UpdateThingShadow", "iot:DeleteThingShadow"]
          Resource: "*"
        - Effect: Allow
          Action: ["greengrass:*"]
          Resource: "*"

  CoreCertCorePolicyAttachment:
    Type: AWS::IoT::PolicyPrincipalAttachment
    Properties:
      Principal: !GetAtt CoreCert.Arn
      PolicyName: !Ref CorePolicy

  CoreDefinition:
    Type: Custom::GrassFormationCoreDefinition
    Properties:
      ServiceToken:
        Fn::ImportValue: !Join ["-", [!Ref GFStackName, CoreHandlerLambdaFunctionArn]]
      Name: !Join ["_", [!Ref GroupNameParameter, "Core"]]
      Cores:
      - CertificateArn: !GetAtt CoreCert.Arn
        Id: !Ref CoreThing
        SyncShadow: true
        ThingArn: !Join ["", ["arn:", !Ref "AWS::Partition", ":iot:", !Ref "AWS::Region", ":", !Ref "AWS::AccountId", ":thing/", !Ref CoreThing]]

  ResourceDefinition:
    Type: Custom::GrassFormationResourceDefinition
    Properties:
      ServiceToken:
        Fn::ImportValue: !Join ["-", [!Ref GFStackName, ResourceHandlerLambdaFunctionArn]]
      Name: !Join ["_", [!Ref GroupNameParameter, "Resources"]]
      Resources:
      - Id: !Join ["_", [!Ref GroupNameParameter, "Resource", "videoDevice"]]
        Name: "videoDevice"
        ResourceDataContainer:
          LocalDeviceResourceData:
            GroupOwnerSetting:
              AutoAddGroupOwner: true
            SourcePath: "/dev/video0"
      - Id: !Join ["_", [!Ref GroupNameParameter, "Resource", "videoCoreInterface"]]
        Name: "videoCoreInterface"
        ResourceDataContainer:
          LocalDeviceResourceData:
            GroupOwnerSetting:
              AutoAddGroupOwner: true
            SourcePath: "/dev/vchiq"
      - Id: !Join ["_", [!Ref GroupNameParameter, "Resource", "videoCoreSharedMemory"]]
        Name: "videoCoreSharedMemory"
        ResourceDataContainer:
          LocalDeviceResourceData:
            GroupOwnerSetting:
              AutoAddGroupOwner: true
            SourcePath: "/dev/vcsm"
      - Id: !Join ["_", [!Ref GroupNameParameter, "Resource", "GStreamerKVSPlugingPath"]]
        Name: "GStreamerKVSPlugingPath"
        ResourceDataContainer:
          LocalVolumeResourceData:
            GroupOwnerSetting:
              AutoAddGroupOwner: true
            SourcePath: "/home/pi/opt/amazon-kinesis-video-streams-producer-sdk-cpp/kinesis-video-native-build/downloads/local/lib"
            DestinationPath: "/kvs/local/lib"

  LoggerDefinition:
    Type: Custom::GrassFormationLoggerDefinition
    Properties:
      ServiceToken:
        Fn::ImportValue: !Join ["-", [!Ref GFStackName, LoggerHandlerLambdaFunctionArn]]
      Name: !Join ["_", [!Ref GroupNameParameter, "Loggers"]]
      Loggers:
      - Type: FileSystem
        Component: GreengrassSystem
        Level: INFO
        Space: 25600
        Id: !Join ["_", [!Ref GroupNameParameter, "Logger", "FileSystem", "GreengrassSystem"]]
      - Type: FileSystem
        Component: Lambda
        Level: WARN
        Space: 25600
        Id: !Join ["_", [!Ref GroupNameParameter, "Logger", "FileSystem", "Lambda"]]
      - Type: AWSCloudWatch
        Component: Lambda
        Level: WARN
        Id: !Join ["_", [!Ref GroupNameParameter, "Logger", "AWSCloudWatch", "Lambda"]]

  SubscriptionDefinition:
    Type: Custom::GrassFormationSubscriptionDefinition
    Properties:
      ServiceToken:
        Fn::ImportValue: !Join ["-", [!Ref GFStackName, SubscriptionHandlerLambdaFunctionArn]]
      Name: !Join ["_", [!Ref GroupNameParameter, "Subscriptions"]]
      Subscriptions:
        - Id: !Join ["_", [!Ref GroupNameParameter, "Subscription", "Shadow", "Lambda"]]
          Source: GGShadowService
          Target: !Ref CoreShadowHandlerARN
          Subject: !Join ["/", ["$aws/things", !Ref CoreThing, "shadow/update/delta"]]

  FunctionDefinition:
    Type: Custom::GrassFormationFunctionDefinition
    Properties:
      ServiceToken:
        Fn::ImportValue: !Join ["-", [!Ref GFStackName, FunctionHandlerLambdaFunctionArn]]
      Name: !Join ["_", [!Ref GroupNameParameter, "Functions"]]
      Functions:
        - FunctionArn: !Ref IoTLambdaARN
          FunctionConfiguration:
            EncodingType: json
            Environment:
              AccessSysfs: false
              ResourceAccessPolicies:
                - ResourceId: !Join ["_", [!Ref GroupNameParameter, "Resource", "videoDevice"]]
                  Permission: rw
                - ResourceId: !Join ["_", [!Ref GroupNameParameter, "Resource", "videoCoreSharedMemory"]]
                  Permission: rw
                - ResourceId: !Join ["_", [!Ref GroupNameParameter, "Resource", "videoCoreInterface"]]
                  Permission: rw
                - ResourceId: !Join ["_", [!Ref GroupNameParameter, "Resource", "GStreamerKVSPlugingPath"]]
                  Permission: ro
              Variables:
                AWS_DEFAULT_REGION: !Ref "AWS::Region"
                KVS_NAME: janos-raspberry-pi-stream
                GST_PLUGIN_PATH: "/kvs/local/lib"
                LD_LIBRARY_PATH: "/kvs/local/lib"
            Executable: lambda.handler
            MemorySize: 131072
            Pinned: true
            Timeout: 30
          Id: !Join ["_", [!Ref GroupNameParameter, "Function", "nsp-instore-streamer-dev-iot-runner"]]

  GreengrassGroup:
    Type: Custom::GrassFormationGroup
    Properties:
      ServiceToken:
        Fn::ImportValue: !Join ["-", [!Ref GFStackName, GroupHandlerLambdaFunctionArn]]
      Name: !Ref GroupNameParameter
      CoreDefinitionVersionArn: !GetAtt CoreDefinition.LatestVersionArn
      ResourceDefinitionVersionArn: !GetAtt ResourceDefinition.LatestVersionArn
      LoggerDefinitionVersionArn: !GetAtt LoggerDefinition.LatestVersionArn
      SubscriptionDefinitionVersionArn: !GetAtt SubscriptionDefinition.LatestVersionArn
      FunctionDefinitionVersionArn: !GetAtt FunctionDefinition.LatestVersionArn
